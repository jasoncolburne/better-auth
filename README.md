# better-auth

Better Auth is a pluggable authentication protocol, agnostic to platform, encoding, cryptographic
and storage choices. Designed to be accessible, flexible and secure.

Examples given are encoded using CESR (Composable Event Streaming Representation) and ideas
about forward secrecy came from KERI (Key Event Receipt Infrastructure).

The examples were generated by the
[reference typescript implementation](https://github.com/jasoncolburne/better-auth-ts)
which is a great place to learn more about how this works.

This has yet to be formally reviewed, and the claude implementations have barely been reviewed by
me. I got them working and plan to come back for polish.

Client implementations:
- [typescript](https://github.com/jasoncolburne/better-auth-ts)
- [dart (claude)](https://github.com/jasoncolburne/better-auth-dart)
- [swift (claude)](https://github.com/jasoncolburne/better-auth-swift)
- [kotlin (claude)](https://github.com/jasoncolburne/better-auth-kt)
- [python (claude)](https://github.com/jasoncolburne/better-auth-py)

Server implementations:
- [golang](https://github.com/jasoncolburne/better-auth-go)
- [typescript](https://github.com/jasoncolburne/better-auth-ts)
- [python (claude)](https://github.com/jasoncolburne/better-auth-py)
- [ruby (claude)](https://github.com/jasoncolburne/better-auth-rb)

## Protocols

### Creation

To start, we need a recovery public key as an input. Then, we use a client interface to generate
two more keypairs and an identity. One key pair to reveal immediately and use for authentication,
and the other to reveal in the future when rotating. The identity derivation is up to the
implementer, but could conceivably go as far as a DKMS like KERI. The verification of this identity
is performed in another server side interface, before returning a response.

`device` is simply a hash digest of the `publicKey`, and the protocol handles this transformation
and verification.

`request`

```json
{
  "payload": {
    "access": {
      "nonce": "0AAX1217iPESswcOzc49ChCk"
    },
    "request": {
      "authentication": {
        "device": "EGl2IqkCnIAEotkH_NA-UsvUga5uDitIiDLx6y_GALhf",
        "identity": "EKuTJxCHK8tjaOfC1aYrl0_m4VO2Yt0-k0SG3v4F0SDE",
        "publicKey": "1AAIAoJRFSWyKMvc-lJGY24NTR255P8NcBaT29HDNKWDAmMA",
        "recoveryHash": "EAM6B4QdeQvvO_hEn7iM6TRVTQ4DlgK23c4rsCS1ggo-",
        "rotationHash": "ECx50wctdUhW6_4Sawswkk86BLTgtf-kW_eMW2Z4dot-"
      }
    }
  },
  "signature": "0ICfxvqkEyB-lk4HvE6Eq2bltcgefa2IdHfqxEanpj6-CAjlFYzJMWOnvBAIMUFmGJZpUbYw5LdibZRn5zpX7nvQ"
}
```

The server interfaces should check for uniqueness of `identity` and ensure it does not exist, which
is important because the client controls creation. Using the established methods, `device` and
`identity` should be verified. The `recoveryHash` should next be registered in storage with a
lookup key of `identity`. Finally the `publicKey` and `rotationHash` should be stored against a key
that looks like `(identity, device)`. This ordering ensures an account is never available for
authentication until a `recoveryHash` has been established.

`response`

```json
{
  "payload": {
    "access": {
      "nonce": "0AAX1217iPESswcOzc49ChCk",
      "responseKeyHash": "EGUd_C9yOGHsjFmDRwURCW4Gm0fTcjMXrqqIXodmCNhK"
    },
    "response": {}
  },
  "signature": "0ICpXDLNXQ6ELlgmHEqOLtEX3ZU2UrtFubsQIxB2v6SrrGdck5NWST8S4l0QU7yCki7BLoPy-O05STWasATimwup"
}
```

### Recovery

We registered a `recoveryHash` on account creation. Here, we pass the `recoveryKey` to the server
and sign with it, sending details to establish a new device against an existing identity in the
backend. It also revokes access to all existing devices. We establish a new recovery key when we use
the existing one.

`request`

```json
{
  "payload": {
    "access": {
      "nonce": "0ADjrHcwerMcdbYPJJP62WXL"
    },
    "request": {
      "authentication": {
        "device": "EJtf5PUAn_wKhDamJ9OEDxTqe_pLmSIddHganf6QTDAw",
        "identity": "EPsriX39yi4lN6C546gGwiJlVeCywCMoe-HCph_4GJ6b",
        "publicKey": "1AAIAqHSAc8Tb_8SyixUWI1cEwW4xH4ndb9m_qNHVX4Cj_7w",
        "recoveryHash": "EHRTVnQ0yygrCD-3IQSJAnDgRQToop_VM2ek6fOyCiho",
        "recoveryKey": "1AAIA8fJAMQdUqHHpaQ3xWdLIoe1e7fOtgfGS4jvW-w5KES4",
        "rotationHash": "EGOC9ZxnBIoOHHM453ZHIyyxaCJForR2ZN44bl8AQUYD"
      }
    }
  },
  "signature": "0ICVrvXMfnyNS95OxntsFz7Kh9ZP1kmMVVyZL-e-LPrFdvOM7Hg7_BENRbEXJSWg4Mwi75HLExqCLt2vRmM-_-US"
}
```

The server verifies the key by looking up `recoveryHash` and recomputing. If the hash matches, the
signature is verified using `recoveryKey`. `device` should be checked for uniqueness. If all is
well, the backend registers `publicKey` and `rotationHash` against a key that looks like
`(identity, device)`.

`response`

```json
{
  "payload": {
    "access": {
      "nonce": "0ADjrHcwerMcdbYPJJP62WXL",
      "responseKeyHash": "EIETXX_jRHwSq2XLYMOIZsiBXW5OCzRW0BVs22wATOIg"
    },
    "response": {}
  },
  "signature": "0IAlLzIi2WVsKlg4tm1wwasc4ja6D-0lbJ0XHjxr3Y2AmHHmkFNYVRx9iLpw_scwwA4fN70LqZkEGmImSKEkZ7Qj"
}
```

### Linking

This is a link container, it is generated by the new device, and contains enough data to link a
device to an existing identity.

```json
{
  "payload": {
    "authentication": {
      "device": "EJVONI0W_hanelZcHPVAaHUDK7QudJ1tJ5fUB2u3OXHs",
      "identity": "EJ2TUUoI9iR0LAET2Q7PU2Xsx7eGLhyOzBbkJuohbc5F",
      "publicKey": "1AAIA3O40fpa9I1EcZtgMnBzBF1rRxIHm-8yvJorUJcw5xvu",
      "rotationHash": "EGXYU1ktvnULIFWrZjxxtFd3WOg49Fhob-Hz29nYaGR3"
    }
  },
  "signature": "0ICxc-i-i5-eS8imWLM8TiFnZFoDrtlCOvo8yICorYOKHJSjjt7sO8-knNXTcvaD_6qsyF9VNUjmBmHP_j8jxxqr"
}
```

The container is embedded in a message created and signed by the existing device. A rotation is
performed by the existing device.

`request`

```json
{
  "payload": {
    "access": {
      "nonce": "0AAIxCZAMFWEwxXt6po73uqq"
    },
    "request": {
      "authentication": {
        "device": "EC8qbX_6aWdOAEmlSu3NjWFM4qOTGmQl6BAz58ciu9_L",
        "identity": "EJ2TUUoI9iR0LAET2Q7PU2Xsx7eGLhyOzBbkJuohbc5F",
        "publicKey": "1AAIA-C3Kj0sOdEV6b23D-l77hGl_eSnhw_sHIG3CkN2f-we",
        "rotationHash": "EPspdz0-QuUN8KMZ7OWFB_iblX66J8WCls49E3i4yT8-"
      },
      "link": {
        "payload": {
          "authentication": {
            "device": "EJVONI0W_hanelZcHPVAaHUDK7QudJ1tJ5fUB2u3OXHs",
            "identity": "EJ2TUUoI9iR0LAET2Q7PU2Xsx7eGLhyOzBbkJuohbc5F",
            "publicKey": "1AAIA3O40fpa9I1EcZtgMnBzBF1rRxIHm-8yvJorUJcw5xvu",
            "rotationHash": "EGXYU1ktvnULIFWrZjxxtFd3WOg49Fhob-Hz29nYaGR3"
          }
        },
        "signature": "0ICxc-i-i5-eS8imWLM8TiFnZFoDrtlCOvo8yICorYOKHJSjjt7sO8-knNXTcvaD_6qsyF9VNUjmBmHP_j8jxxqr"
      }
    }
  },
  "signature": "0ICZNnQmvrQw_WtwN4IUph9Nh8fnoQODW_5S36avMaBeg2_W9zu-8HKKEoAl1eQuDsqPsPLowfJ9csrXNbwcPS4Z"
}
```

After verifying the authentication signature from the existing device (via the `authentication`
part of the request), the `link` object is parsed and verified, and a new set of device keys is
registered in storage.

`response`

```json
{
  "payload": {
    "access": {
      "nonce": "0AAIxCZAMFWEwxXt6po73uqq",
      "responseKeyHash": "EBRjwZl9eIxcafuxSzAMDvKkoFp5JX5VYAfc4PuR32Ph"
    },
    "response": {}
  },
  "signature": "0IDWE8V-go8N3AgqRL7FnAkQ0qQ4ME4KRVRGkgEmes_XKj9oCDP-91eLxWudS4DvXtyQpZl29J5N-uZFXnPvUy-4"
}
```

### Unlinking

Unlinking involves a rotation followed by revoking access to the linked device.

```json
{
  "payload": {
    "access": {
      "nonce": "0AB-xE0UITbeD9Sjg5SKDwjm"
    },
    "request": {
      "authentication": {
        "device": "EJVONI0W_hanelZcHPVAaHUDK7QudJ1tJ5fUB2u3OXHs",
        "identity": "EJ2TUUoI9iR0LAET2Q7PU2Xsx7eGLhyOzBbkJuohbc5F",
        "publicKey": "1AAIAhjUBJOlpKAB8pWVjzQwc9SL01mmPBe9yjQC654uoobK",
        "rotationHash": "EF107ZAMgWCHr4yLA3LRJF2hGxRVdo2HCYCtVf44EeGX"
      },
      "link": {
        "device": "EC8qbX_6aWdOAEmlSu3NjWFM4qOTGmQl6BAz58ciu9_L"
      }
    }
  },
  "signature": "0IDa5PWGtspEStA82Q_Q1hx1IEl8sdK1z_btjafugY4LDFC4rbuS35X-5PHgzIyJgrfZ8PbauNj2m8uI0VIrUw0y"
}
```

```json
{
  "payload": {
    "access": {
      "nonce": "0AB-xE0UITbeD9Sjg5SKDwjm",
      "responseKeyHash": "EBRjwZl9eIxcafuxSzAMDvKkoFp5JX5VYAfc4PuR32Ph"
    },
    "response": {}
  },
  "signature": "0IByNlTTv0Z2jEnyJsWzaLXPsLkJGjVlAFM96xeEESx2kC65HHzKsVDKdnZXb-VMb90IqPiHQdm3-XBjvyGsI3pe"
}
```

### Rotation

To rotate to a new key, the device reveals the hidden rotation key, turns it into the public key
for that device, and establishes a new rotation key using a hash, signing with the newly-revealed
key. 

`request`

```json
{
  "payload": {
    "access": {
      "nonce": "0AB5jri4Umnpo3cNkWYO0pj1"
    },
    "request": {
      "authentication": {
        "device": "EGl2IqkCnIAEotkH_NA-UsvUga5uDitIiDLx6y_GALhf",
        "identity": "EKuTJxCHK8tjaOfC1aYrl0_m4VO2Yt0-k0SG3v4F0SDE",
        "publicKey": "1AAIA4D1uEGo859PLefOcUFT36WFUemhe8bFy7J1PosGtz8m",
        "rotationHash": "EEeFSjSV3Z98A_MbOCPdyUarTdPah_HUSTMwYdM4NWWf"
      }
    }
  },
  "signature": "0IDpbBUea8y5WmmmxauYWZl-9S1yjZFD-P-BT0V0izAugXLe5ZqEkPgR5GoxIyy_xKz131DS2j8R_qy-1g2rjhsm"
}
```

`response`

```json
{
  "payload": {
    "access": {
      "nonce": "0AB5jri4Umnpo3cNkWYO0pj1",
      "responseKeyHash": "EGUd_C9yOGHsjFmDRwURCW4Gm0fTcjMXrqqIXodmCNhK"
    },
    "response": {}
  },
  "signature": "0ICcvcZcwr8W9a3j-VhDVX4J9P32UbI4UknFZRnpCmNF0ancH6OB2GxRe3-2prvpUKLNYK3ddy9oKh6c0PV1nfb_"
}
```

### Authentication

Authentication is accomplished with a challenge/response performed in two phases.

`request` (request for challenge)

```json
{
  "payload": {
    "access": {
      "nonce": "0AAy-cxcY7GRBmUqiLWFisyD"
    },
    "request": {
      "authentication": {
        "identity": "EKuTJxCHK8tjaOfC1aYrl0_m4VO2Yt0-k0SG3v4F0SDE"
      }
    }
  }
}
```

`response` (challenge)

```json
{
  "payload": {
    "access": {
      "nonce": "0AAy-cxcY7GRBmUqiLWFisyD",
      "responseKeyHash": "EGUd_C9yOGHsjFmDRwURCW4Gm0fTcjMXrqqIXodmCNhK"
    },
    "response": {
      "authentication": {
        "nonce": "0ADJWfDSLX7U0KaASNoPBqAO"
      }
    }
  },
  "signature": "0IC-oLP5ozz8I9uKAyyTBy_nHN__Ee4D3vdKY6x41_f4-Gl8l29PEZfBTJ1dGqqSjs28K3K8J2YBop_99TPH2TFg"
}
```

`request` (response to challenge)

```json
{
  "payload": {
    "access": {
      "nonce": "0ABA1uX_o30qOv0LBwbmZYm5"
    },
    "request": {
      "access": {
        "publicKey": "1AAIAjkNyw6v5yYc6oooT91Ng_aeyQmi2hJLYmYPMqXhfb5f",
        "rotationHash": "ELVLMWKHyX--rf4rtjWxGHpeIEkHMzSMvNPI4eKw8C3V"
      },
      "authentication": {
        "device": "EGl2IqkCnIAEotkH_NA-UsvUga5uDitIiDLx6y_GALhf",
        "nonce": "0ADJWfDSLX7U0KaASNoPBqAO"
      }
    }
  },
  "signature": "0ICJ3M2fAMrhK7Fl4WfmdJyNdcOmChml8LTT_Ak9lTR_W_uUNvbyFukhyCt98jm-vvfgSLcdHj1SmNsEH7ynhcEt"
}
```

`response` (grant)

```json
{
  "payload": {
    "access": {
      "nonce": "0ABA1uX_o30qOv0LBwbmZYm5",
      "responseKeyHash": "EGUd_C9yOGHsjFmDRwURCW4Gm0fTcjMXrqqIXodmCNhK"
    },
    "response": {
      "access": {
        "token": "0IDM5Cl_aBgD3gHaDA1QnrKroy0NkCq3ha1vGYTMXLP05C4LjzXoK_DwfX8s6EiBIAUHsEyHTllxonvDyO2CjPCnH4sIAAAAAAACA22P3XKCMBBG3yXXpRMwscodtVQU8acyKu10nChLiYrQENDU4d0be0v3cuecb_e7IR7DWXKpkI1cvwrH14Hn9-SBzZKBySJxwtuMrGZWJLFxxMthpyavePniogdUVLsT3_twV03HGTmH41RdujVV0b6b53nYN6dfWwZqkXErHU-iLJoH35s02dFE6yKXTPL87LEyvR-frCbB2vfUxjBEQoQ8rK9Dr4CRe_SCn2VQT-cjAv6lN-istM3LsoLYkdq0sEUNExvYCs0nm2CbWI-E9vHfvGsWrgUXqkVS2iIFJALK1G0JnRDT_6KZlILvKgklsm-oAJHpx3Sp8lm95Se4L1mc8TOyP3Q4i7VyEVwC-mya5hf7PJzZfQEAAA"
      }
    }
  },
  "signature": "0IA73SUXvRZwDCmSW9juZ5IUMbCKJeC5z4pY-G_yLsOGxj87zUxd_JiYwkbpSPNUIgH7fwF5cd8tL3wUevXsDHa3"
}
```

### Refresh

This rotates the access key.

`request`

```json
{
  "payload": {
    "access": {
      "nonce": "0ACrw-zc0zVZchNPs0AM11Xs"
    },
    "request": {
      "access": {
        "publicKey": "1AAIAn7_UaaZ5JxUM0rSM4uA3Pg4ACk7_FCQGX5pGlq7tyyC",
        "rotationHash": "EO-AQK8B3v9si4C_jpmmnjp1OpGDYwh9r14Y2m2LS1p1",
        "token": "0IDM5Cl_aBgD3gHaDA1QnrKroy0NkCq3ha1vGYTMXLP05C4LjzXoK_DwfX8s6EiBIAUHsEyHTllxonvDyO2CjPCnH4sIAAAAAAACA22P3XKCMBBG3yXXpRMwscodtVQU8acyKu10nChLiYrQENDU4d0be0v3cuecb_e7IR7DWXKpkI1cvwrH14Hn9-SBzZKBySJxwtuMrGZWJLFxxMthpyavePniogdUVLsT3_twV03HGTmH41RdujVV0b6b53nYN6dfWwZqkXErHU-iLJoH35s02dFE6yKXTPL87LEyvR-frCbB2vfUxjBEQoQ8rK9Dr4CRe_SCn2VQT-cjAv6lN-istM3LsoLYkdq0sEUNExvYCs0nm2CbWI-E9vHfvGsWrgUXqkVS2iIFJALK1G0JnRDT_6KZlILvKgklsm-oAJHpx3Sp8lm95Se4L1mc8TOyP3Q4i7VyEVwC-mya5hf7PJzZfQEAAA"
      }
    }
  },
  "signature": "0IAVTldM51oR7OmKfmiwKm5k8CEAjNuj-6tReEtBfmUY1BmMbg3vKiawW9_L3fZXoFXvD8T12HRvMQJkUv195Gss"
}
```

`response` (new token)

```json
{
  "payload": {
    "access": {
      "nonce": "0ACrw-zc0zVZchNPs0AM11Xs",
      "responseKeyHash": "EGUd_C9yOGHsjFmDRwURCW4Gm0fTcjMXrqqIXodmCNhK"
    },
    "response": {
      "access": {
        "token": "0IAAHRJH12qyYZtBgszy_iU1EkqZ_HyGb5rNPn95AKKEM1v2i150naF_pgFRhis5Ni1LoaThdWY_vMvCmrvGPBj9H4sIAAAAAAACA2XPXW-CMBQG4P_S67G00A7lrqLiZIY5dBkuC6mjzipg1xaFGP_76pJlF57Lk_c5H2cgCl4bYToQgFHcLKZtOIl7ZseSTYhYpkqYV_g1cTMDnT1MI--IxzAdjsAdkM26FJ8xv1JE6SOt_XzJ2IpM2-UMqnSGG-o9f2Ea7v18HM6jNyKj8ts3XRdarg6GGXGoJ0xvr8sTh87j3sA79rXAYb6TVVXvJEpkNMxO275COHMr9ylFElkttG54QY2VLnSJg6AD3QXyAwwD7N7jBwx_a2WzvJVCdTdJQm6Sim8U19vRDfAWkPyNJv1_wIxRYt0YrkFwBpKryh5mn9KD7uVQ8muTFZWoQfBuh7PCkpMShoOPy-XyA46k7DB9AQAA"
      }
    }
  },
  "signature": "0IDbizH83_Nl0ASD0oV25Y-mLn7aM_avT57_2KX31bzoS6m0NlKuf-s2xdfhI0LWH1ocTHmdtE7SqkrZKu4u--c1"
}
```

### Access

An access request is a resource request that is verified using the embedded token.

`request`

```json
{
  "payload": {
    "access": {
      "nonce": "0ACBe98dynuT5bIedslFdGs4",
      "timestamp": "2025-10-02T17:40:42.465000000Z",
      "token": "0IAAHRJH12qyYZtBgszy_iU1EkqZ_HyGb5rNPn95AKKEM1v2i150naF_pgFRhis5Ni1LoaThdWY_vMvCmrvGPBj9H4sIAAAAAAACA2XPXW-CMBQG4P_S67G00A7lrqLiZIY5dBkuC6mjzipg1xaFGP_76pJlF57Lk_c5H2cgCl4bYToQgFHcLKZtOIl7ZseSTYhYpkqYV_g1cTMDnT1MI--IxzAdjsAdkM26FJ8xv1JE6SOt_XzJ2IpM2-UMqnSGG-o9f2Ea7v18HM6jNyKj8ts3XRdarg6GGXGoJ0xvr8sTh87j3sA79rXAYb6TVVXvJEpkNMxO275COHMr9ylFElkttG54QY2VLnSJg6AD3QXyAwwD7N7jBwx_a2WzvJVCdTdJQm6Sim8U19vRDfAWkPyNJv1_wIxRYt0YrkFwBpKryh5mn9KD7uVQ8muTFZWoQfBuh7PCkpMShoOPy-XyA46k7DB9AQAA"
    },
    "request": {
      "foo": "bar",
      "bar": "foo"
    }
  },
  "signature": "0IDkakf3wvvoXFw6QZV1z6cQbqfrnT-XJ_ybyd4bk0FIoodqzkZjJFYSP5cDss50ZatTafYpsBe4twNaFjNTEP4f"
}
```

`response`

```json
{
  "payload": {
    "access": {
      "nonce": "0ACBe98dynuT5bIedslFdGs4",
      "responseKeyHash": "1AAIAmF5voh0rTbS8SYgg0lLT3wkhJ7DiBt7dfILrFEUERHE"
    },
    "response": {
      "wasFoo": "bar",
      "wasBar": "foo"
    }
  },
  "signature": "0ICnft5lNctwMau2ZxOOlLMEf9kcxBRb6Dl1bmWIpPfeQaEx7xTSnIIJihluV1-bWFYOc9LYjpUL14kCc18LttQB"
}
```

## Appendix

### AccessToken encoding

If we re-pad a token from the example implementation with `=`, we can decode it in a shell (the
first 88 bytes is the signature, in this case):

```sh
TOKEN="0IBtdsv8LEQ0oKAA52h8jEwHOUctJ8JFq7ZoQ3MPyXynhUmcJUEKzI5h38W7kGSWJlGmJypNDsNCxMXMoHmzOnF4H4sIAAAAAAACA23PW0-DMBQH8O_SZzGFdeXyBgq7D-euzJiFwdmo24C0ZYLLvrudiTFRz-PJ_3cuF8RSyCWTDXKQP-6yfrXaF4-jid0tN4soPPbSxA9zMg2tk7AWH0FTJ6zcmRW6Q2W1PbJkADequ27PzfHaM_uDJNA1Og1bNBb8AKNhr6XPaeHWyyALR33rAJrNFOeFjCUr8m4sstvyYdTJCDHms6dJMgvom1wc9uOVT7W5X0fLjldvJg-eGXlnSJRmQlSQulJJAxttDdua0Z5h4hDLIfQeWwR_1VploS4Zb34l2w5u_Uly2HEQmf8P0On3aNP-AbGUnG0rCQI5F1QCP6nD1FPCa56LI9yacXpiOXJe1PA4VeSdMwno9Xq9fgKhoI45fQEAAA=="
echo -n ${TOKEN:88} | base64 -d | gunzip | jq .
```

produces

```json
{
  "identity": "ENHiJuXgoDMQ9Hp_VYOlIdcEOn4SO8ms8VzFyxcipf7u",
  "publicKey": "1AAIAn0ZB7JKcF1-6SO36asrkeMLI31U6oAxWFhOMJ8ke-9i",
  "rotationHash": "ELYGh442UTPQcTF6jtVkgNXE6-UExYWGBx_QCB7YBvec",
  "issuedAt": "2025-09-25T04:48:46.084000000Z",
  "expiry": "2025-09-25T05:03:46.084000000Z",
  "refreshExpiry": "2025-09-25T16:48:46.079000000Z",
  "attributes": {
    "permissionsByRole": {
      "admin": [
        "read",
        "write"
      ]
    }
  }
}
```
