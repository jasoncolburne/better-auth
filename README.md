# better-auth

Examples given are encoded using CESR (Composable Event Streaming Representation) and ideas
surrounding forward secrecy came from KERI (Key Event Receipt Infrastructure)

The examples given were generated by the [reference typescript implementation](https://github.com/jasoncolburne/better-auth-ts)
which is a great place to learn more about how this works.

## Protocols

### Creation

generate an identity (identifier) on the client, this could be backed by something like KERI
but that isn't necessary. it's important to verify the format of identifiers before
registering them in your backend, since the client has control of creation.

request

```json
{
  "payload": {
    "access": {
      "nonce": "0ACszT7be5L0EEhEfpGYGIas"
    },
    "request": {
      "authentication": {
        "device": "EOEoABkOfw5QICEpXEZetIjozI9LGMZpCMrMQ1HX60Ed",
        "identity": "ENHiJuXgoDMQ9Hp_VYOlIdcEOn4SO8ms8VzFyxcipf7u",
        "publicKey": "1AAIAlhFXjtJi0wXskouXyQbGjmG-7a9QqpLUyp5Lo7CYunB",
        "recoveryHash": "EIKCiFJEbqsFZTTKT7rhPLNWsnuDkKbPCPRiV-DWJlGp",
        "rotationHash": "EHGQUg1Y64b59sxEWVPqBNiDihinqt_3IbWWueINaaNF"
      }
    }
  },
  "signature": "0IBAwjp0aM3tTbt-Nwq8tNPIaG2hE-Zg17tFLzlpw4dms6aDjYIj8bNDS6zqf62LM9JKF0WF53Gjy0pMP1b_FNYD"
}
```

response

```json
{
  "payload": {
    "access": {
      "nonce": "0ACszT7be5L0EEhEfpGYGIas",
      "responseKeyHash": "EJoo3Kn_QJD4ULMG8dNqeRh_y0Jb18IZUxDHjwUi3W1F"
    },
    "response": {}
  },
  "signature": "0IAqk6yYbrsENqYqlsQLDBMnBeOVY4jxbqYXjS7d2LEXYcvTi12PvVHvrDUHonWkXG81bcVrDZN6EqZ3voI2vdX0"
}
```

### Recovery

request

```json
{
  "payload": {
    "access": {
      "nonce": "0ABh9BQp-_GvekPBXamnQTYB"
    },
    "request": {
      "authentication": {
        "device": "EFNvlgDCpYTIAd7P4WG_MgC4JUFna2h5TAjAVVFTGwlM",
        "identity": "EISvVSWxdggDueijS_pbT-Twx-UcOgdGG0VwOG8Ky5cF",
        "publicKey": "1AAIAk2OZbqwZ-7X87Am-dzkaV6cRT0_7Ocgf9OxXkTYB2Qm",
        "recoveryKey": "1AAIArhgv36b-cgRezBxpnx7FuNxiD0hvfxlgLcC2hND37Ml",
        "rotationHash": "ENmZAva0lnrVOUfYacpLTlWAn5rZQfEAfpSlkKuTUCjh"
      }
    }
  },
  "signature": "0ICmASSjSJmdE78Ij6zuuUpYxfzUook61acLjcKjvQskENkr4GK7kuHqe0Q6U-_Xfoc1d8awabRQVBHolrwt3wih"
}
```

response

```json
{
  "payload": {
    "access": {
      "nonce": "0ABh9BQp-_GvekPBXamnQTYB",
      "responseKeyHash": "EPNM0YZ-OaFSoePpmu672lIHeX7qRhnnUYVxIvyi_loj"
    },
    "response": {}
  },
  "signature": "0IAWT4uc0AD5rBY9VbnX_u--vs8pYxhYG-7rLQpl9DPQL4Bp1q2nZ6KdRKKIL4QKmlw_hIgxzrizk7QQy--mplQ-"
}
```

### Linking

this is a link container, it is generated by the new device

```json
{
  "payload": {
    "authentication": {
      "device": "ELzdIXRzYpbPVlbeve2CFYRtyTR2aBnjwBmhw_eGywUG",
      "identity": "EFnJC9w1hDoOKOwK-FeTyBviOJitJOZasLXjEqXe2OPr",
      "publicKey": "1AAIAjOyX53s64ZvOQxlswFikfh0Q1f25AgPXPHXdZdLV5ts",
      "rotationHash": "EMkmOV6ZYQ-koDPEqAzMODCOBsJtMraF4TZEKfFtn2ck"
    }
  },
  "signature": "0ICxu8UJBDpjALEnnUVaDojCg-dnK-6x9Fi1zi3XDxn9WdWYBgMarswDtWDHjcjSanJTJ-sdKKU2QRpuoraVDipg"
}
```

the container is embedded in the existing device:

request

```json
{
  "payload": {
    "access": {
      "nonce": "0ACm_cccP7H5QjYf9N_LI88b"
    },
    "request": {
      "authentication": {
        "device": "EMvR6iBaXSEF7GK09OycMr8Lgv_Y_7-xGYg-rwcUJhqX",
        "identity": "EFnJC9w1hDoOKOwK-FeTyBviOJitJOZasLXjEqXe2OPr"
      },
      "link": {
        "payload": {
          "authentication": {
            "device": "ELzdIXRzYpbPVlbeve2CFYRtyTR2aBnjwBmhw_eGywUG",
            "identity": "EFnJC9w1hDoOKOwK-FeTyBviOJitJOZasLXjEqXe2OPr",
            "publicKey": "1AAIAjOyX53s64ZvOQxlswFikfh0Q1f25AgPXPHXdZdLV5ts",
            "rotationHash": "EMkmOV6ZYQ-koDPEqAzMODCOBsJtMraF4TZEKfFtn2ck"
          }
        },
        "signature": "0ICxu8UJBDpjALEnnUVaDojCg-dnK-6x9Fi1zi3XDxn9WdWYBgMarswDtWDHjcjSanJTJ-sdKKU2QRpuoraVDipg"
      }
    }
  },
  "signature": "0IBB1Aix3j0wERSudOZsZ10bpedY5xIyXL3BASUcqP-garriRfIQC5jhx4SyhzOK7Nrf2kguEVkv3HmvAKRhtE-h"
}
```

response

```json
{
  "payload": {
    "access": {
      "nonce": "0ACm_cccP7H5QjYf9N_LI88b",
      "responseKeyHash": "EJILn4arvA8DYeODMG79W5rR9eSQdzaL2LZ0bHMIDJVu"
    },
    "response": {}
  },
  "signature": "0IA5XGma9VfQRx-MIZL1wTLIWtKON4XMG0wj8Ytwdxv7XnEiDySW2RpxO9WVDmIYNUCPlGAwkxDkrifoYrmRu5lF"
}
```

### Rotation

request

```json
{
  "payload": {
    "access": {
      "nonce": "0AB-DjQ2oVqEhNTQSizGTLGT"
    },
    "request": {
      "authentication": {
        "device": "EOEoABkOfw5QICEpXEZetIjozI9LGMZpCMrMQ1HX60Ed",
        "identity": "ENHiJuXgoDMQ9Hp_VYOlIdcEOn4SO8ms8VzFyxcipf7u",
        "publicKey": "1AAIA_Z1KlpD3_Cpgr-b-nZ954ZN0IsjyfQ8Eam11s0WIQm9",
        "rotationHash": "EBlA-amN24Z0XcPUntbRHDIO4oNzD7ObROnORfSJ6fWm"
      }
    }
  },
  "signature": "0IBk0Sr1dVfgZLMrHJ3Mi84TygtbH8pOmNS6sVZS6gHnnP8PfXAeBjbd8WM9NFkFO-wWLdBc2jPFXo6BJ6TT0N6c"
}
```

response

```json
{
  "payload": {
    "access": {
      "nonce": "0AB-DjQ2oVqEhNTQSizGTLGT",
      "responseKeyHash": "EJoo3Kn_QJD4ULMG8dNqeRh_y0Jb18IZUxDHjwUi3W1F"
    },
    "response": {}
  },
  "signature": "0IAEG56eWfMHh5LPp-viB0p4WRPCHcbEb-3hqok8tJUF9PhY9I8VD296dhuNgt-zK8vlSQaTQBpOBsWLl6BxaG9H"
}
```

### Authentication

request (request for challenge)

```json
{
  "payload": {
    "access": {
      "nonce": "0AASTPXrOEVzaKSw-OSwiaA9"
    },
    "request": {
      "authentication": {
        "identity": "ENHiJuXgoDMQ9Hp_VYOlIdcEOn4SO8ms8VzFyxcipf7u"
      }
    }
  }
}
```

response (challenge)

```json
{
  "payload": {
    "access": {
      "nonce": "0AASTPXrOEVzaKSw-OSwiaA9",
      "responseKeyHash": "EJoo3Kn_QJD4ULMG8dNqeRh_y0Jb18IZUxDHjwUi3W1F"
    },
    "response": {
      "authentication": {
        "nonce": "0ACoTGJg8TBJQnkoJsIqrWe3"
      }
    }
  },
  "signature": "0ID1z8ybs-PfcnU3YVjT2oodhxzt_pz5_ABeV-m1tqoF_3-MIOk3y5ou4jxDtUBtntaLDfYXzRlXNcgBT85mLIWj"
}
```

request (response to challenge)

```json
{
  "payload": {
    "access": {
      "nonce": "0AA9Htl8-FOJn8PboKe98jRM"
    },
    "request": {
      "access": {
        "publicKey": "1AAIA-kYrQOA7qTxPwUp7haaPYebZL1A0u3P-oN39iautIVO",
        "rotationHash": "EIESMjKT_KTZuk9GOKQ296JENmvRktHE1BPfa053QVCl"
      },
      "authentication": {
        "device": "EOEoABkOfw5QICEpXEZetIjozI9LGMZpCMrMQ1HX60Ed",
        "nonce": "0ACoTGJg8TBJQnkoJsIqrWe3"
      }
    }
  },
  "signature": "0IC3VWBFMbBcC1tup0rKGrHNRcF5HakGiN7JlcERvw6Z8WOyRlXyPMJTDI9I08ClZ7t6Gs2cEsP0SdJynelzPC0P"
}
```

response (grant)

```json
{
  "payload": {
    "access": {
      "nonce": "0AA9Htl8-FOJn8PboKe98jRM",
      "responseKeyHash": "EJoo3Kn_QJD4ULMG8dNqeRh_y0Jb18IZUxDHjwUi3W1F"
    },
    "response": {
      "access": {
        "token": "0IDcS5Q8dIH7A2apLn_r7arT2dpyWZlAQSve8Y2nagtMe2x_raEEFATKDpXGLyP7M6GcSCmXZH-4FVqp0L7x0uH0H4sIAAAAAAACA22PXVOCQBSG_8teR7N8iXCHRYGkgBITNo2zyhqbfLUfCTn899Yuy3N55nnec94zIAVuOOEDcIC39MlcvLy394vE9rttlkdVUOy9qDHW0bRm0-z7Yej3pDtYAtyATuwqsg_xRVVdN3CVY06TyLU-0z4-PXdWiVCc493mSXWh0GOlXeo2QYIHWSR12nLESdv4iJWX44G3XnyE6TZMN-JoP0ZhotmTubesv1ZH7nvqLD4gaOpJdldJmzAmcOFyaWpQMxVoK5qZQsMxpo4xuYWWDX9nI1ncd4QOf0jTgfo_kuIDxaz0rgjq5Fo04pySneCYAecMOkxr-ZgsxWbDqq3wZYmKmjTAeZXhqJDKiRKOwds4jj_ztEDqfQEAAA"
      }
    }
  },
  "signature": "0ICuwqVBKBCEFd7wC0r4N1rvKEWle2bcindSn2bH9p99EUnYwmiQJrXj1Py85bl-cpvzIpDqIpQH6YM2ucvG8x9-"
}
```

### Refresh

this rotates the access key

request

```json
{
  "payload": {
    "access": {
      "nonce": "0ADFy15mdC6CabCkzosTQyZL"
    },
    "request": {
      "access": {
        "publicKey": "1AAIAn0ZB7JKcF1-6SO36asrkeMLI31U6oAxWFhOMJ8ke-9i",
        "rotationHash": "ELYGh442UTPQcTF6jtVkgNXE6-UExYWGBx_QCB7YBvec",
        "token": "0IDcS5Q8dIH7A2apLn_r7arT2dpyWZlAQSve8Y2nagtMe2x_raEEFATKDpXGLyP7M6GcSCmXZH-4FVqp0L7x0uH0H4sIAAAAAAACA22PXVOCQBSG_8teR7N8iXCHRYGkgBITNo2zyhqbfLUfCTn899Yuy3N55nnec94zIAVuOOEDcIC39MlcvLy394vE9rttlkdVUOy9qDHW0bRm0-z7Yej3pDtYAtyATuwqsg_xRVVdN3CVY06TyLU-0z4-PXdWiVCc493mSXWh0GOlXeo2QYIHWSR12nLESdv4iJWX44G3XnyE6TZMN-JoP0ZhotmTubesv1ZH7nvqLD4gaOpJdldJmzAmcOFyaWpQMxVoK5qZQsMxpo4xuYWWDX9nI1ncd4QOf0jTgfo_kuIDxaz0rgjq5Fo04pySneCYAecMOkxr-ZgsxWbDqq3wZYmKmjTAeZXhqJDKiRKOwds4jj_ztEDqfQEAAA"
      }
    }
  },
  "signature": "0IByr2FzJLYmOaJWuIqtDKM4LQRu2iJR4bULEqdKT0eGo7pHve4gHfeItRQguF1KngNgo8_bDJNj_xEeXb-fdRsh"
}
```

response (new token)

```json
{
  "payload": {
    "access": {
      "nonce": "0ADFy15mdC6CabCkzosTQyZL",
      "responseKeyHash": "EJoo3Kn_QJD4ULMG8dNqeRh_y0Jb18IZUxDHjwUi3W1F"
    },
    "response": {
      "access": {
        "token": "0IBtdsv8LEQ0oKAA52h8jEwHOUctJ8JFq7ZoQ3MPyXynhUmcJUEKzI5h38W7kGSWJlGmJypNDsNCxMXMoHmzOnF4H4sIAAAAAAACA23PW0-DMBQH8O_SZzGFdeXyBgq7D-euzJiFwdmo24C0ZYLLvrudiTFRz-PJ_3cuF8RSyCWTDXKQP-6yfrXaF4-jid0tN4soPPbSxA9zMg2tk7AWH0FTJ6zcmRW6Q2W1PbJkADequ27PzfHaM_uDJNA1Og1bNBb8AKNhr6XPaeHWyyALR33rAJrNFOeFjCUr8m4sstvyYdTJCDHms6dJMgvom1wc9uOVT7W5X0fLjldvJg-eGXlnSJRmQlSQulJJAxttDdua0Z5h4hDLIfQeWwR_1VploS4Zb34l2w5u_Uly2HEQmf8P0On3aNP-AbGUnG0rCQI5F1QCP6nD1FPCa56LI9yacXpiOXJe1PA4VeSdMwno9Xq9fgKhoI45fQEAAA"
      }
    }
  },
  "signature": "0IAMHQ48_WRP8a58xn7VKoUmNClowvYymwZnzAj4YeZpivX_CKyh7ezLz_6RmkFmINE2wXbPfm-tvTrSQQ6_6Kns"
}
```

### Access

request

```json
{
  "payload": {
    "access": {
      "nonce": "0ACbI0jyAczp45JeYeOIgM9Y",
      "timestamp": "2025-09-25T04:48:46.086000000Z",
      "token": "0IBtdsv8LEQ0oKAA52h8jEwHOUctJ8JFq7ZoQ3MPyXynhUmcJUEKzI5h38W7kGSWJlGmJypNDsNCxMXMoHmzOnF4H4sIAAAAAAACA23PW0-DMBQH8O_SZzGFdeXyBgq7D-euzJiFwdmo24C0ZYLLvrudiTFRz-PJ_3cuF8RSyCWTDXKQP-6yfrXaF4-jid0tN4soPPbSxA9zMg2tk7AWH0FTJ6zcmRW6Q2W1PbJkADequ27PzfHaM_uDJNA1Og1bNBb8AKNhr6XPaeHWyyALR33rAJrNFOeFjCUr8m4sstvyYdTJCDHms6dJMgvom1wc9uOVT7W5X0fLjldvJg-eGXlnSJRmQlSQulJJAxttDdua0Z5h4hDLIfQeWwR_1VploS4Zb34l2w5u_Uly2HEQmf8P0On3aNP-AbGUnG0rCQI5F1QCP6nD1FPCa56LI9yacXpiOXJe1PA4VeSdMwno9Xq9fgKhoI45fQEAAA"
    },
    "request": {
      "foo": "bar",
      "bar": "foo"
    }
  },
  "signature": "0IAygXGe0ohdpFmuX_1Tjcj7IJUXFrQXAPAXpklJ7aQP8_Z2KeWO67-mTBjaHie3jHYfsCDE908Cs6gSR8s_1Es8"
}
```

response

```json
{
  "payload": {
    "access": {
      "nonce": "0ACbI0jyAczp45JeYeOIgM9Y",
      "responseKeyHash": "1AAIAxZ-QOGpmZs7sZg0GZPaBQdocslBcEiSMF7XXkXJHCu9"
    },
    "response": {
      "wasFoo": "bar",
      "wasBar": "foo"
    }
  },
  "signature": "0IBl8VyJHRsklJn_1yQ-EFuVf4qATlP0hlWhBMG34BLgd2o8ryzqTWXf1Uo9kiyNdzSZ3mhUAWwZVBB8ulvmYH1s"
}
```

## Appendix

### AccessToken encoding

If we re-pad a token with `=`, we can decode it in a shell (the first 88 bytes is the signature):

```sh
TOKEN="0IBtdsv8LEQ0oKAA52h8jEwHOUctJ8JFq7ZoQ3MPyXynhUmcJUEKzI5h38W7kGSWJlGmJypNDsNCxMXMoHmzOnF4H4sIAAAAAAACA23PW0-DMBQH8O_SZzGFdeXyBgq7D-euzJiFwdmo24C0ZYLLvrudiTFRz-PJ_3cuF8RSyCWTDXKQP-6yfrXaF4-jid0tN4soPPbSxA9zMg2tk7AWH0FTJ6zcmRW6Q2W1PbJkADequ27PzfHaM_uDJNA1Og1bNBb8AKNhr6XPaeHWyyALR33rAJrNFOeFjCUr8m4sstvyYdTJCDHms6dJMgvom1wc9uOVT7W5X0fLjldvJg-eGXlnSJRmQlSQulJJAxttDdua0Z5h4hDLIfQeWwR_1VploS4Zb34l2w5u_Uly2HEQmf8P0On3aNP-AbGUnG0rCQI5F1QCP6nD1FPCa56LI9yacXpiOXJe1PA4VeSdMwno9Xq9fgKhoI45fQEAAA=="
echo -n ${TOKEN:88} | base64 -d | gunzip | jq .
```

produces

```json
{
  "identity": "ENHiJuXgoDMQ9Hp_VYOlIdcEOn4SO8ms8VzFyxcipf7u",
  "publicKey": "1AAIAn0ZB7JKcF1-6SO36asrkeMLI31U6oAxWFhOMJ8ke-9i",
  "rotationHash": "ELYGh442UTPQcTF6jtVkgNXE6-UExYWGBx_QCB7YBvec",
  "issuedAt": "2025-09-25T04:48:46.084000000Z",
  "expiry": "2025-09-25T05:03:46.084000000Z",
  "refreshExpiry": "2025-09-25T16:48:46.079000000Z",
  "attributes": {
    "permissionsByRole": {
      "admin": [
        "read",
        "write"
      ]
    }
  }
}
```
